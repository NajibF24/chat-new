variables:
  # --- KONFIGURASI UMUM ---
  GIT_CLONE_PATH: '$CI_BUILDS_DIR/$CI_CONCURRENT_ID/project-portal-ai'
  GIT_CLEAN_FLAGS: -ffdx -e data/
  GIT_DEPTH: "0"

  # --- DOCKER IMAGES ---
  SERVER_IMAGE: $CI_REGISTRY_IMAGE/server:$CI_COMMIT_SHORT_SHA
  SERVER_IMAGE_LATEST: $CI_REGISTRY_IMAGE/server:latest
  CLIENT_IMAGE: $CI_REGISTRY_IMAGE/client:$CI_COMMIT_SHORT_SHA
  CLIENT_IMAGE_LATEST: $CI_REGISTRY_IMAGE/client:latest

  TARGET_URL: "https://chat.gyssteel.com"

stages:
  - build
  - deploy

# ==========================================================
# 1. BUILD STAGE (Dipisah antara Server & Client)
# ==========================================================

build_server:
  stage: build
  tags:
    - portal-ai
  only:
    - main
  rules:
    - changes:
        - server/**/* # Hanya jalan jika ada perubahan di folder server
  before_script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin $CI_REGISTRY
  script:
    - echo "ðŸ—ï¸ Building Server Image..."
    - docker build -t $SERVER_IMAGE -t $SERVER_IMAGE_LATEST ./server
    - docker push $SERVER_IMAGE
    - docker push $SERVER_IMAGE_LATEST

build_client:
  stage: build
  tags:
    - portal-ai
  only:
    - main
  rules:
    - changes:
        - client/**/* # Hanya jalan jika ada perubahan di folder client
  before_script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin $CI_REGISTRY
  script:
    - echo "ðŸ—ï¸ Building Client Image..."
    - docker build --no-cache --build-arg REACT_APP_API_URL=${REACT_APP_API_URL} -t $CLIENT_IMAGE -t $CLIENT_IMAGE_LATEST ./client
    - docker push $CLIENT_IMAGE
    - docker push $CLIENT_IMAGE_LATEST

# ==========================================================
# 2. DEPLOY STAGE (Dipisah agar tidak mengganggu satu sama lain)
# ==========================================================

deploy_server:
  stage: deploy
  tags:
    - portal-ai
  only:
    - main
  rules:
    - changes:
        - server/**/*
  needs: ["build_server"]
  before_script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin $CI_REGISTRY
  script:
    - echo "ðŸš€ Updating Server Service..."
    - echo "$DOT_ENV_FILE" > .env
    - docker pull $SERVER_IMAGE_LATEST
    # Hanya restart service server tanpa mematikan yang lain
    - docker compose up -d --no-deps --force-recreate server
    - docker image prune -f

deploy_client:
  stage: deploy
  tags:
    - portal-ai
  only:
    - main
  rules:
    - changes:
        - client/**/*
  needs: ["build_client"]
  before_script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin $CI_REGISTRY
  script:
    - echo "ðŸš€ Updating Client Service..."
    - echo "$DOT_ENV_FILE" > .env
    - docker pull $CLIENT_IMAGE_LATEST
    # Hanya restart service client tanpa mematikan yang lain
    - docker compose up -d --no-deps --force-recreate client
    - docker image prune -f
