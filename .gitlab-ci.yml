variables:
  # --- KONFIGURASI UMUM ---
  GIT_CLONE_PATH: '$CI_BUILDS_DIR/$CI_CONCURRENT_ID/project-portal-ai'
  GIT_CLEAN_FLAGS: -ffdx -e data/
  GIT_DEPTH: "0"

  # --- DOCKER IMAGES (Versioning dengan SHA Commit) ---
  SERVER_IMAGE: $CI_REGISTRY_IMAGE/server:$CI_COMMIT_SHORT_SHA
  SERVER_IMAGE_LATEST: $CI_REGISTRY_IMAGE/server:latest
  CLIENT_IMAGE: $CI_REGISTRY_IMAGE/client:$CI_COMMIT_SHORT_SHA
  CLIENT_IMAGE_LATEST: $CI_REGISTRY_IMAGE/client:latest

  # --- TARGET ---
  TARGET_URL: "https://chat.gyssteel.com"

stages:
  - build         # Docker Build
  - deploy        # Deploy ke Server

# ==========================================================
# 1. BUILD & PUSH DOCKER IMAGES
# ==========================================================
build_push_images:
  stage: build
  tags:
    - portal-ai
  only:
    - main
  before_script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin $CI_REGISTRY
  script:
    - echo "ðŸ—ï¸ Building & Pushing Images..."
    - echo "$DOT_ENV_FILE" > .env
    
    # Server (Menggunakan cache default)
    - docker build -t $SERVER_IMAGE -t $SERVER_IMAGE_LATEST ./server
    - docker push $SERVER_IMAGE
    - docker push $SERVER_IMAGE_LATEST
    
    # Client (Memaksa no-cache agar membaca ulang konfigurasi baru)
    - docker build --no-cache --build-arg REACT_APP_API_URL=${REACT_APP_API_URL} -t $CLIENT_IMAGE -t $CLIENT_IMAGE_LATEST ./client
    - docker push $CLIENT_IMAGE
    - docker push $CLIENT_IMAGE_LATEST

# ==========================================================
# 2. DEPLOY TO PRODUCTION
# ==========================================================
deploy_production:
  stage: deploy
  tags:
    - portal-ai
  only:
    - main
  # âœ… FIX: Ketergantungan diubah langsung menunjuk ke job build
  needs: ["build_push_images"] 
  before_script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin $CI_REGISTRY      
  script:
    - echo "ðŸš€ Memulai Deployment..."
    - echo "$DOT_ENV_FILE" > .env
    
    # Bersihkan container lama
    - docker rm -f mongo internal-chat-server internal-chat-client || true
    - docker compose down --remove-orphans || true
    
    # Pull image terbaru
    - docker pull $SERVER_IMAGE_LATEST
    - docker pull $CLIENT_IMAGE_LATEST
    
    # Start Services
    - docker compose up -d --force-recreate
    - sleep 10
    
    # Bersihkan image/cache Docker yang tidak terpakai (Opsional tapi bagus untuk server)
    - docker image prune -f
