stages:
  - build
  - deploy

# --- JOB 1: BUILD IMAGE ---
# Memastikan kodingan tidak error sebelum dideploy
build_images:
  stage: build
  tags:
    - portal-ai
  only:
    - main
  script:
    - echo "ðŸ—ï¸ Memulai Build..."
    # Restore file .env dari GitLab Variable
    - echo "$DOT_ENV_FILE" > .env
    # Build image (hasil build akan tersimpan di cache server)
    - docker compose build
    - echo "âœ… Build Selesai."

# --- JOB 2: DEPLOY PRODUCTION ---
deploy_production:
  stage: deploy
  tags:
    - portal-ai
  only:
    - main
  # Hanya jalan kalau build sukses
  needs: ["build_images"]
  
  variables:
    # [SANGAT PENTING]
    # Mencegah Runner menghapus folder 'data/' saat persiapan (git clean)
    # Ini solusi ampuh untuk menghindari error "Permission denied" saat clean up.
    GIT_CLEAN_FLAGS: -ffdx -e data/
  
  script:
    - echo "ðŸš€ Memulai Deployment..."
    
    # 1. Restore .env
    - echo "$DOT_ENV_FILE" > .env
    
    # 2. Hapus container lama secara paksa (Safety Net)
    # Supaya tidak ada error "Conflict container name"
    - docker rm -f mongo internal-chat-server internal-chat-client || true
    
    # 3. Turunkan service yang sedang jalan
    - docker compose down --remove-orphans || true
    
    # 4. Jalankan Aplikasi
    # Karena path di docker-compose.yml sudah Absolute (/home/admingys/...),
    # Docker akan otomatis mount ke folder yang benar.
    - docker compose up -d 
    
    # 5. Cek Kesehatan Container (Opsional)
    - sleep 10
    - docker compose ps

    # 6. Bersihkan image bekas update
    - docker image prune -f
    
    - echo "âœ… Deployment Sukses! Aplikasi sudah update."
